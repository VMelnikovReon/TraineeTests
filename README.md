# 4 Наводим красоту.

## Цель: Научиться взаимодействовать с разными сущностями amoCRM.

## Задача: Доработка функционала crm-системы для косметологической клиники.

## Для реализации данной задачи используется подготовленный шаблон интеграции  на TypeScript из п.3

!!! Важно: Каждый этап отправляется на проверку через Pull Request из отдельной ветки в ветку “development”

## 1 Этап:
В карточке контакта создать поля типа «Число» для следующих видов услуг:
Лазерное омоложение лица;
Ультразвуковой лифтинг;
Лазерное удаление сосудов;
Коррекция мимических морщин;
Лазерная эпиляция;
В карточке сделки создать поле «Услуги» типа «Мультисписок» с вариантами выбора:
Лазерное омоложение лица;
Ультразвуковой лифтинг;
Лазерное удаление сосудов;
Коррекция мимических морщин;
Лазерная эпиляция.

Создать новую интеграцию, которая будет вычислять бюджет (сумму) сделки при изменении выбранных услуг в поле «Услуги» в карточке сделки. Данные о стоимости услуг интеграция будет брать из полей соответствующих услуг в карточке контакта прикрепленного к сделке. В случае, если контакт не прикреплен к сделке, то бюджет не высчитывается. В случае, если контактов прикреплено к сделке 2 и более данные о стоимости услуг берутся из контакта, который является главным (main);
Данные о бюджете записывать в стандартное поле «бюджет».

## 2 Этап:
При успешном изменении бюджета в карточке сделки создавать задачу с типом «Проверить». Если такого типа задачи не существует, создать его в crm.
Текст задачи - «Проверить бюджет»
В случае если такая задача в карточке уже существует, новая задача не создается. Ответственным за задачу назначать ответственного за сделку.
Дедлайн проставленной задачи - 24 часа.

## 3 Этап:
При закрытии задачи «Проверить бюджет» в карточке сделки, к которой она прикреплена, автоматически должно создаваться примечание с текстом «Бюджет проверен, ошибок нет»

# 5. Интеграция для каждого.

## Цель: Научиться загружать код виджета в amoCRM и получать доступы для работы в аккаунте.

## Задача: Подготовить серверную часть виджета для получения и хранения токенов от нескольких аккаунтов для корректной работы будущего виджета. Токены доступа необходимо сохранить в отдельную директорию с токенами и идентифицировать какому клиенту они принадлежат. 

## Этапы выполнения: 
Сформировать zip архив с виджетом (директория “widget” в шаблоне)
Создать Приватную интеграцию в аккаунте 
При установке/удалении виджета на указанную  в настройках ссылку приходит GET-запрос с необходимыми нам данными.
Подготовить серверную часть так, чтобы по указанным ссылкам приходили данные при установке и удалении виджета.
Расширить серверную часть интеграции для хранения токенов в соответствии с основной задачей.
Передать Pull Request на проверку.


## 5.1. Интеграция для каждого (Расширение)

Задача: Перенести хранение токенов клиентов в отдельную Базу Данных.

Этапы выполнения: 
Развернуть подключение к БД (mongodb)
Подготовить коллекцию аккаунтов
Сохранять данные аккаунта (id, домен, токены) при установке виджета, также добавить поле статус установки виджета
Удалять токены при удалении виджета из аккаунта, при этом изменять статус виджета в БД на “Не установлен”
Передать Pull Request на проверку.

# 6. База клиентов

## Цель: Научиться формировать тестовые данные и взаимодействовать с базой данных.

## Задача: Подготовить тестовую базу данных клиентов, услуг и расписания для косметологической клиники. 

## Этапы выполнения: 
Подготовить функцию которая формирует набор клиентских данных. 

## Сущность “Клиент” должна содержать следующий набор данных: 
ID (генерировать случайный UUID)
Имя
Фамилия
Отчество
Дата Рождения
Номер телефона

При вызове функция формирует массив случайной длины от 10 до 200 уникальных клиентов.

Подготовить функцию которая формирует набор услуг.

## Сущность “Услуга” Должна содержать следующий набор данных: 
ID (генерировать случайный UUID)
Наименование
Код (буквенно-цифровое значение)
Стоимость
Описание

Пример услуг можно взять из п.4. данного документа, При вызове функции формируется массив от 5 до 10 уникальных услуг.
Подготовить функцию, которая формирует таблицу расписаний клиентов.

Функция должна принимать в качестве аргументов набор созданных пользователей и услуг и будет на основании полученных данных формировать таблицу расписаний клиентов.

## Сущность “Посещение” содержит следующий набор данных: 
ID (генерировать случайный UUID)
Клиент
Планируемая дата и время
Фактическая дата и время
Статус посещения (запланирован, посетил, отменил)
Услуги (массив услуг)
Стоимость

Функция должна формировать набор от 100 до 3000 элементов. 

Для посещений со статусом: “Запланирован” и “Отменил”, поле “фактическая дата и время” не должно быть заполнено, а также должны  отсутствовать данные в полях “услуги” и “стоимость”. 

Для посещений со статусом “Посетил” должно быть заполнено поле “фактическая дата и время” значение в поле НЕ должно быть меньше (раньше) чем значение в поле “планируемая дата и время”, а также должно быть заполнено поле “услуги” и в поле ”стоимость” указана сумма оказанных услуг. 

Подготовить соответствующие модели для хранении в базе данных (mongodb)
Реализовать функцию, которая выполняет формирование данных описанных выше, выполняет подключение к БД и выполняет загрузку данных в соответствующие коллекции.
Добавить в package.json скрипт который, будет вызывать функцию заполнения БД. Скрипт запускается командой “npm run fill db”
Выполнить тестовую загрузку данных.
Сделать Pull Request и передать на проверку.
